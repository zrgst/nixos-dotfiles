#!/usr/bin/env bash

NOTES_DIR="$HOME/notes"
mkdir -p "$NOTES_DIR"

case "${1:-}" in
	todo|-t)
		# Find all todos in notes, select with fzf, open at exact line.
		selected=$(grep -rn "\- \[ \]" "$NOTES_DIR" 2>/dev/null |\
			fzf --delimiter=: \
			--preview="bat --color=always --highlight-line {2} {1} 2>/dev/null || cat {1}")

		if [[ -n "$selected" ]]; then
			file=$(echo "$selected" | cut -d: -f1)
			line=$(echo "$selected" | cut -d: -f2)
			vim "+$line" "$file"
		fi
		;;
	search|-s)
		# Search inside notes
		selected=$(grep -rn "${2:-}" "$NOTES_DIR" 2>/dev/null | \
			fzf --delimiter=: \
				--preview="bat --color=always --highlight-line {2} {1} 2>/dev/null || cat {1}" \
				--preview-window="up:60%")
		if [[ -n "$selected" ]]; then
			file=$(echo "$selected" | cut -d: -f1)
			line=$(echo "$selected" | cut -d: -f2)
			vim "+$line" "$file"
		fi
		;;
	list|-l)
		# List all notes with preview
		selected=$(find "$NOTES_DIR" -type f -name "*.md" -print0 2>/dev/null | \
			xargs -0 ls -t 2>/dev/null | \
			fzf --preview="bat --color=always {} 2>/dev/null || cat {}")

		[[ -n "$selected" ]] && vim "$selected"
		;;
	sync|-y)
		# sync with github
		cd "$NOTES_DIR" || exit 1

		if [[ ! -d .git ]]; then
			echo "Initializing git repo..."
			git init
		fi

		# Check for remote origin
		if ! git remote get-url origin &>/dev/null; then
			echo -n "Enter git remote URL: "
			read -r remote_url
			if [[ -n "$remote_url" ]]; then
				git remote add origin "$remote_url"
			else
				echo "No remote url provided, skipping sync..."
				exit 1
			fi
		fi

		# Sync: pull, add, commit, push
		git pull --rebase origin "$(git branch --show-current)" 2>/dev/null || true
		git add -A
		if ! git diff --cached --quiet; then
			git commit -m "sync: $(date '+%Y-%m-%d %H:%M')"
		fi
		git push -u origin "$(git branch --show-current)"
		echo "Synced!"
		;;
	*)
		# Open note by name or today's note if no arg
		if [[ -n "${1:-}" ]]; then
			note_path="$NOTES_DIR/$1"
			# check for '.md' and add if needed
			[[ "$note_path" != *.md ]] && note_path="$note_path.md"
			mkdir -p "$(dirname "$note_path")"
			vim "$note_path"
		else
			DATE=$(date +%Y-%m-%d)
			vim "$NOTES_DIR/$DATE.md"
		fi
		;;
esac


